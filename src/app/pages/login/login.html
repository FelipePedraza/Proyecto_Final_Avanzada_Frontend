<main class="container dashboard-container">
  <div class="login-container" style="display: flex; justify-content: center; align-items: flex-start; min-height: calc(100vh - 200px); padding: 2rem 0;">

    <!-- ==================== SECCIÓN LOGIN ==================== -->
    @if (vistaActual === VistaLogin.LOGIN) {
      <section
        class="dashboard-content"
        style="width: 100%; max-width: 800px; margin: 0;">

        <div class="content-header" style="text-align: center; margin-bottom: 3rem;">
          <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Bienvenido de vuelta</h1>
          <p style="font-size: 1.2rem; color: #7F8C8D;">Inicia sesión para continuar tu aventura</p>
        </div>

        <div class="form-container">
          <form [formGroup]="loginForm" (ngSubmit)="login()" novalidate>
            <div class="form-grid" style="max-width: 700px; margin: 0 auto;">

              <!-- Email -->
              <div class="form-group full-width">
                <label for="email">Correo Electrónico *</label>
                <input
                  type="email"
                  id="email"
                  formControlName="email"
                  placeholder="tu@email.com"
                  autocomplete="email"
                  [class.error]="formUtilsService.campoInvalido(loginForm, 'email')">

                @if (formUtilsService.campoInvalido(loginForm, 'email')) {
                  <div class="error-message show">
                    {{ formUtilsService.obtenerErrorCampo(loginForm, 'email') }}
                  </div>
                }
              </div>

              <!-- Contraseña -->
              <div class="form-group full-width">
                <label for="contrasena">Contraseña *</label>
                <div class="password-input-container" style="position: relative;">
                  <input
                    [type]="mostrarContrasena ? 'text' : 'password'"
                    id="contrasena"
                    formControlName="contrasena"
                    placeholder="Tu contraseña"
                    autocomplete="current-password"
                    [class.error]="formUtilsService.campoInvalido(loginForm, 'contrasena')">

                  <button
                    type="button"
                    class="password-toggle"
                    (click)="toggleContrasena()"
                    [attr.aria-label]="mostrarContrasena ? 'Ocultar contraseña' : 'Mostrar contraseña'"
                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #7F8C8D; cursor: pointer;">
                    <i [class]="mostrarContrasena ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                  </button>
                </div>

                @if (formUtilsService.campoInvalido(loginForm, 'contrasena')) {
                  <div class="error-message show">
                    {{ formUtilsService.obtenerErrorCampo(loginForm, 'contrasena') }}
                  </div>
                }
              </div>

              <!-- Olvidé mi contraseña -->
              <div class="form-group full-width">
                <div style="display: flex; justify-content: flex-end; align-items: center;">
                  <a
                    (click)="cambiarVista(VistaLogin.RECUPERAR)"
                    style="color: var(--primary-color); font-weight: 500; text-decoration: none; font-size: 0.9rem; cursor: pointer;">
                    ¿Olvidaste tu contraseña?
                  </a>
                </div>
              </div>

              <!-- Botón de login -->
              <div class="form-group full-width">
                <div style="display: flex; justify-content: center;">
                  <button
                    type="submit"
                    [disabled]="cargando || loginForm.invalid"
                    class="btn btn-primary"
                    style="width: 300px; padding: 16px 24px; font-size: 1.1rem;">

                    @if (cargando) {
                      <span class="loading-spinner"></span>
                      Iniciando...
                    } @else {
                      <i class="fa-solid fa-right-to-bracket"></i>
                      Iniciar Sesión
                    }
                  </button>
                </div>
              </div>

            </div>
          </form>

          <!-- Link a registro -->
          <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-green); max-width: 700px; margin-left: auto; margin-right: auto;">
            <p style="font-size: 1.1rem;">
              ¿No tienes una cuenta?
              <a routerLink="/registro" style="color: var(--primary-color); font-weight: 600;">Regístrate gratis</a>
            </p>
          </div>
        </div>
      </section>
    }

    <!-- ==================== SECCIÓN RECUPERAR CONTRASEÑA ==================== -->
    @if (vistaActual === VistaLogin.RECUPERAR) {
      <section
        class="dashboard-content"
        style="width: 100%; max-width: 800px; margin: 0;">

        <div class="content-header" style="text-align: center; margin-bottom: 3rem;">
          <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">¿Olvidaste tu contraseña?</h1>
          <p style="font-size: 1.2rem; color: #7F8C8D;">No te preocupes, te enviaremos un enlace para restablecerla</p>
        </div>

        <div class="form-container">
          <form [formGroup]="recuperarForm" (ngSubmit)="recuperarContrasena()">
            <div class="form-grid" style="max-width: 700px; margin: 0 auto;">

              <!-- Email para recuperación -->
              <div class="form-group full-width">
                <label for="resetEmail">Correo Electrónico *</label>
                <input
                  type="email"
                  id="resetEmail"
                  formControlName="email"
                  placeholder="tu@email.com"
                  [class.error]="formUtilsService.campoInvalido(recuperarForm, 'email')">

                @if (formUtilsService.campoInvalido(recuperarForm, 'email')) {
                  <div class="error-message show">
                    {{ formUtilsService.obtenerErrorCampo(recuperarForm, 'email') }}
                  </div>
                }
              </div>

              <!-- Botón enviar -->
              <div class="form-group full-width">
                <div style="display: flex; justify-content: center;">
                  <button
                    type="submit"
                    [disabled]="cargando || recuperarForm.invalid"
                    class="btn btn-primary"
                    style="width: 300px; padding: 16px 24px; font-size: 1.1rem;">

                    @if (cargando) {
                      <span class="loading-spinner"></span>
                      Enviando...
                    } @else {
                      <i class="fa-solid fa-paper-plane"></i>
                      Enviar enlace de recuperación
                    }
                  </button>
                </div>
              </div>
            </div>
          </form>

          <!-- Volver al login -->
          <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-green); max-width: 700px; margin-left: auto; margin-right: auto;">
            <a
              (click)="cambiarVista(VistaLogin.LOGIN)"
              style="color: var(--primary-color); font-weight: 600; font-size: 1.1rem; cursor: pointer;">
              <i class="fa-solid fa-arrow-left"></i> Volver al inicio de sesión
            </a>
          </div>
        </div>
      </section>
    }

    <!-- ==================== SECCIÓN ÉXITO ==================== -->
    @if (vistaActual === VistaLogin.EXITO) {
      <section
        class="dashboard-content"
        style="width: 100%; max-width: 800px; margin: 0;">

        <div class="content-header" style="text-align: center; margin-bottom: 3rem;">
          <div style="color: var(--success-color); font-size: 4rem; margin-bottom: 1rem;">
            <i class="fa-solid fa-check-circle"></i>
          </div>
          <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">¡Enlace enviado!</h1>
          <p style="font-size: 1.2rem; color: #7F8C8D;">
            Hemos enviado un enlace de recuperación a
            <strong style="color: var(--primary-color);">{{ emailRecuperacion }}</strong>
          </p>
        </div>

        <div class="form-container" style="text-align: center; max-width: 700px; margin: 0 auto;">
          <div style="background-color: var(--light-green); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
            <p style="margin-bottom: 1rem; color: var(--text-color);">
              <i class="fa-solid fa-info-circle"></i>
              Revisa tu bandeja de entrada y sigue las instrucciones para restablecer tu contraseña.
            </p>
            <p style="color: #7F8C8D; font-size: 0.9rem;">
              Si no ves el correo, revisa tu carpeta de spam o correo no deseado.
            </p>
          </div>

          <!-- Botón reenviar -->
          <button
            type="button"
            (click)="reenviarEmail()"
            [disabled]="cargando"
            class="btn btn-secondary">

            @if (cargando) {
              <span class="loading-spinner"></span>
              Reenviando...
            } @else {
              <i class="fa-solid fa-refresh"></i>
              Reenviar correo
            }
          </button>

          <!-- Botón para ir al formulario de reinicio -->
          <button
            type="button"
            (click)="cambiarVista(VistaLogin.RESTABLECER)"
            class="btn btn-primary"
            style="margin-top: 1rem;">
            <i class="fa-solid fa-key"></i>
            Ya tengo el código
          </button>

          <!-- Volver al login -->
          <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-green);">
            <a
              (click)="cambiarVista(VistaLogin.LOGIN)"
              style="color: var(--primary-color); font-weight: 600; font-size: 1.1rem; cursor: pointer;">
              <i class="fa-solid fa-arrow-left"></i> Volver al inicio de sesión
            </a>
          </div>
        </div>
      </section>
    }

    <!-- ==================== SECCIÓN RESTABLECER ==================== -->
    @if (vistaActual === VistaLogin.RESTABLECER) {
      <section
        class="dashboard-content"
        style="width: 100%; max-width: 800px; margin: 0;">

        <div class="content-header" style="text-align: center; margin-bottom: 3rem;">
          <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Restablecer Contraseña</h1>
          <p style="font-size: 1.2rem; color: #7F8C8D;">
            Ingresa el código que recibiste y tu nueva contraseña.
          </p>
          <p style="font-size: 1rem; color: #7F8C8D; margin-top: 1rem;">
            Estás restableciendo la contraseña para:
            <strong style="color: var(--primary-color);">{{ emailRecuperacion }}</strong>
          </p>
        </div>

        <div class="form-container">
          <form [formGroup]="restablecerForm" (ngSubmit)="restablecerContrasena()" novalidate>
            <div class="form-grid" style="max-width: 700px; margin: 0 auto;">

              <div class="form-group full-width">
                <label for="codigoVerificacion">Código de Verificación *</label>
                <input
                  type="text"
                  id="codigoVerificacion"
                  formControlName="codigoVerificacion"
                  placeholder="Ingresa el código de 6 dígitos"
                  autocomplete="one-time-code"
                  [class.error]="formUtilsService.campoInvalido(restablecerForm, 'codigoVerificacion')">

                @if (formUtilsService.campoInvalido(restablecerForm, 'codigoVerificacion')) {
                  <div class="error-message show">
                    {{ formUtilsService.obtenerErrorCampo(restablecerForm, 'codigoVerificacion') }}
                  </div>
                }
              </div>

              <div class="form-group full-width">
                <label for="nuevaContrasena">Nueva Contraseña *</label>
                <div class="password-input-container" style="position: relative;">
                  <input
                    [type]="mostrarNuevaContrasena ? 'text' : 'password'"
                    id="nuevaContrasena"
                    formControlName="nuevaContrasena"
                    placeholder="Tu nueva contraseña"
                    autocomplete="new-password"
                    [class.error]="formUtilsService.campoInvalido(restablecerForm, 'nuevaContrasena')">

                  <button
                    type="button"
                    class="password-toggle"
                    (click)="toggleNuevaContrasena()"
                    [attr.aria-label]="mostrarNuevaContrasena ? 'Ocultar contraseña' : 'Mostrar contraseña'"
                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #7F8C8D; cursor: pointer;">
                    <i [class]="mostrarNuevaContrasena ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                  </button>
                </div>

                @if (formUtilsService.campoInvalido(restablecerForm, 'nuevaContrasena')) {
                  <div class="error-message show">
                    {{ formUtilsService.obtenerErrorCampo(restablecerForm, 'nuevaContrasena') }}
                  </div>
                }
              </div>

              <div class="form-group full-width">
                <div style="display: flex; justify-content: center;">
                  <button
                    type="submit"
                    [disabled]="cargando || restablecerForm.invalid"
                    class="btn btn-primary"
                    style="width: 300px; padding: 16px 24px; font-size: 1.1rem;">

                    @if (cargando) {
                      <span class="loading-spinner"></span>
                      Restableciendo...
                    } @else {
                      <i class="fa-solid fa-key"></i>
                      Restablecer Contraseña
                    }
                  </button>
                </div>
              </div>
            </div>
          </form>

          <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--light-green); max-width: 700px; margin-left: auto; margin-right: auto;">
            <a
              (click)="cambiarVista(VistaLogin.LOGIN)"
              style="color: var(--primary-color); font-weight: 600; font-size: 1.1rem; cursor: pointer;">
              <i class="fa-solid fa-arrow-left"></i> Volver al inicio de sesión
            </a>
          </div>
        </div>
      </section>
    }

  </div>
</main>
