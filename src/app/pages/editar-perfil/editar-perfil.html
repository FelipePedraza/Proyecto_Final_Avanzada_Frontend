<main class="container dashboard-container">
  <div class="dashboard-layout">

    <!-- Panel Lateral del Usuario -->
    <app-panel-usuario></app-panel-usuario>

    <!-- Contenido Principal -->
    <section class="dashboard-content">

      <div class="content-header">
        <div>
          <h1>Editar Mi Perfil</h1>
          <p style="color: #7F8C8D; margin-top: 0.5rem;">Actualiza tu información personal y preferencias</p>
        </div>
      </div>

      <!-- Estado de Carga -->
      @if (cargandoUsuario) {
        <div class="loading-container" style="text-align: center; padding: 4rem 2rem;">
          <div class="loading-spinner-large"></div>
          <p style="color: var(--text-color); font-size: 1.1rem; margin-top: 1rem;">
            Cargando información...
          </p>
        </div>
      }

      <!-- Contenido del Perfil -->
      @if (!cargandoUsuario && usuario) {

        <!-- Tabs de Navegación -->
        <div class="tabs">
          <button
            class="tab-link"
            [class.active]="tabActiva === 'personal'"
            (click)="cambiarTab('personal')">
            <i class="fa-solid fa-user"></i> Información Personal
          </button>

          <button
            class="tab-link"
            [class.active]="tabActiva === 'seguridad'"
            (click)="cambiarTab('seguridad')">
            <i class="fa-solid fa-shield-halved"></i> Seguridad
          </button>
        </div>

        <!-- ==================== TAB INFORMACIÓN PERSONAL ==================== -->
        @if (tabActiva === 'personal') {
          <div class="tab-content active">
            <form [formGroup]="perfilForm" (ngSubmit)="guardarPerfil()">
              <div class="form-grid">

                <!-- Foto de Perfil -->
                <div class="form-group full-width" style="text-align: center; margin-bottom: 2rem;">
                  <label>Foto de Perfil</label>
                  <div class="profile-image-container">
                    <div class="current-image">

                      @if (subiendoImagen) {
                        <div class="loading-spinner-large"></div>
                        <p style="margin-top: 1rem; color: var(--text-color);">Subiendo imagen...</p>
                      } @else {
                        <img
                          [src]="fotoPreview || 'https://placehold.co/150x150/2e8b57/fff?text=' + obtenerIniciales()"
                          [alt]="'Foto de ' + usuario.nombre"
                          class="profile-preview">

                        <button
                          type="button"
                          class="btn-icon-camera"
                          (click)="fileInput.click()"
                          [disabled]="subiendoImagen">
                          <i class="fa-solid fa-camera"></i>
                        </button>
                      }
                    </div>

                    <input
                      #fileInput
                      type="file"
                      accept="image/*"
                      (change)="seleccionarImagen($event)"
                      style="display: none;">

                    <button
                      type="button"
                      class="btn btn-secondary"
                      (click)="fileInput.click()"
                      [disabled]="subiendoImagen"
                      style="margin-top: 1rem;">
                      <i class="fa-solid fa-upload"></i> Cambiar Foto
                    </button>
                  </div>
                </div>

                <!-- Nombre Completo -->
                <div class="form-group full-width">
                  <label for="nombre">Nombre Completo *</label>
                  <input
                    type="text"
                    id="nombre"
                    formControlName="nombre"
                    placeholder="Tu nombre completo"
                    [class.error]="campoInvalido(perfilForm, 'nombre')">

                  @if (campoInvalido(perfilForm, 'nombre')) {
                    <div class="error-message show">
                      {{ obtenerErrorCampo(perfilForm, 'nombre') }}
                    </div>
                  }
                </div>

                <!-- Email (solo lectura) -->
                <div class="form-group full-width">
                  <label for="email">Correo Electrónico</label>
                  <input
                    type="email"
                    id="email"
                    [value]="usuario.email"
                    disabled
                    style="background-color: var(--light-green); cursor: not-allowed;">
                  <small style="color: #7F8C8D; font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    <i class="fa-solid fa-info-circle"></i> El email no se puede cambiar. Contacta soporte si necesitas modificarlo.
                  </small>
                </div>

                <!-- Teléfono -->
                <div class="form-group">
                  <label for="telefono">Teléfono *</label>
                  <input
                    type="tel"
                    id="telefono"
                    formControlName="telefono"
                    placeholder="300 123 4567"
                    maxlength="10"
                    [class.error]="campoInvalido(perfilForm, 'telefono')">

                  @if (campoInvalido(perfilForm, 'telefono')) {
                    <div class="error-message show">
                      {{ obtenerErrorCampo(perfilForm, 'telefono') }}
                    </div>
                  }
                </div>

                <!-- Fecha de Nacimiento -->
                <div class="form-group">
                  <label for="fechaNacimiento">Fecha de Nacimiento *</label>
                  <input
                    type="date"
                    id="fechaNacimiento"
                    formControlName="fechaNacimiento"
                    autocomplete="bday"
                    [max]="obtenerFechaMaxima()"
                    [min]="obtenerFechaMinima()"
                    [class.error]="campoInvalido(perfilForm,'fechaNacimiento')">

                  @if (campoInvalido(perfilForm, 'fechaNacimiento')) {
                    <div class="error-message show">
                      {{ obtenerErrorCampo(perfilForm, 'fechaNacimiento') }}
                    </div>
                  }
                </div>

                <!-- Rol del usuario -->
                <div class="form-group full-width">
                  <label>Tipo de Cuenta</label>
                  <div style="padding: 1rem; background-color: var(--light-green); border-radius: 12px;">
                    <p style="margin: 0; display: flex; align-items: center; gap: 8px;">
                      @if (usuario.esAnfitrion) {
                        <i class="fa-solid fa-star" style="color: var(--primary-color);"></i>
                        <strong>Anfitrión</strong> - Puedes publicar alojamientos
                      } @else {
                        <i class="fa-solid fa-user" style="color: var(--primary-color);"></i>
                        <strong>Huésped</strong> - Puedes reservar alojamientos
                      }
                    </p>
                  </div>
                </div>

              </div>

              <!-- Botón Guardar -->
              <div class="form-navigation" style="justify-content: flex-end; border-top: 2px solid var(--light-green); padding-top: 2rem; margin-top: 2rem;">
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="cargando || perfilForm.invalid">

                  @if (cargando) {
                    <span class="loading-spinner"></span>
                    Guardando...
                  } @else {
                    <i class="fa-solid fa-floppy-disk"></i>
                    Guardar Cambios
                  }
                </button>
              </div>
            </form>
          </div>
        }

        <!-- ==================== TAB SEGURIDAD ==================== -->
        @if (tabActiva === 'seguridad') {
          <div class="tab-content active">
            <form [formGroup]="seguridadForm" (ngSubmit)="cambiarContrasena()">
              <div class="form-grid">

                <div class="form-group full-width">
                  <h3 style="color: var(--dark-green); margin-bottom: 1.5rem;">
                    <i class="fa-solid fa-key"></i> Cambiar Contraseña
                  </h3>
                </div>

                <!-- Contraseña Actual -->
                <div class="form-group full-width">
                  <label for="contrasenaActual">Contraseña Actual *</label>
                  <div class="password-input-container">
                    <input
                      [type]="mostrarContrasenaActual ? 'text' : 'password'"
                      id="contrasenaActual"
                      formControlName="contrasenaActual"
                      placeholder="Tu contraseña actual"
                      [class.error]="campoInvalido(seguridadForm, 'contrasenaActual')">

                    <button
                      type="button"
                      class="password-toggle"
                      (click)="toggleContrasena('actual')">
                      <i [class]="mostrarContrasenaActual ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                    </button>
                  </div>

                  @if (campoInvalido(seguridadForm, 'contrasenaActual')) {
                    <div class="error-message show">
                      {{ obtenerErrorCampo(seguridadForm, 'contrasenaActual') }}
                    </div>
                  }
                </div>

                <!-- Nueva Contraseña -->
                <div class="form-group">
                  <label for="contrasenaNueva">Nueva Contraseña *</label>
                  <div class="password-input-container">
                    <input
                      [type]="mostrarNuevaContrasena ? 'text' : 'password'"
                      id="contrasenaNueva"
                      formControlName="contrasenaNueva"
                      placeholder="Tu nueva contraseña"
                      [class.error]="campoInvalido(seguridadForm, 'contrasenaNueva')">

                    <button
                      type="button"
                      class="password-toggle"
                      (click)="toggleContrasena('nueva')">
                      <i [class]="mostrarNuevaContrasena ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                    </button>
                  </div>

                  <!-- Requisitos de contraseña -->
                  <div class="password-requirements">
                    <p><i class="fa-solid fa-info-circle"></i> Debe contener al menos:</p>
                    <ul>
                      <li [class.valid]="validacionContrasena.tieneLongitud">
                        @if (validacionContrasena.tieneLongitud) {
                          <i class="fa-solid fa-check"></i>
                        }
                        8 caracteres
                      </li>
                      <li [class.valid]="validacionContrasena.tieneMayuscula">
                        @if (validacionContrasena.tieneMayuscula) {
                          <i class="fa-solid fa-check"></i>
                        }
                        1 letra mayúscula
                      </li>
                      <li [class.valid]="validacionContrasena.tieneNumero">
                        @if (validacionContrasena.tieneNumero) {
                          <i class="fa-solid fa-check"></i>
                        }
                        1 número
                      </li>
                    </ul>
                  </div>

                  @if (campoInvalido(seguridadForm, 'contrasenaNueva')) {
                    <div class="error-message show">
                      {{ obtenerErrorCampo(seguridadForm, 'contrasenaNueva') }}
                    </div>
                  }
                </div>

                <!-- Confirmar Nueva Contraseña -->
                <div class="form-group">
                  <label for="confirmarContrasena">Confirmar Nueva Contraseña *</label>
                  <div class="password-input-container">
                    <input
                      [type]="mostrarConfirmarContrasena ? 'text' : 'password'"
                      id="confirmarContrasena"
                      formControlName="confirmarContrasena"
                      placeholder="Repite tu nueva contraseña"
                      [class.error]="formularioTieneError(seguridadForm, 'contrasenasNoCoinciden') && seguridadForm.get('confirmarContrasena')?.touched">

                    <button
                      type="button"
                      class="password-toggle"
                      (click)="toggleContrasena('confirmar')">
                      <i [class]="mostrarConfirmarContrasena ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                    </button>
                  </div>

                  @if (formularioTieneError(seguridadForm, 'contrasenasNoCoinciden') && seguridadForm.get('confirmarContrasena')?.touched) {
                    <div class="error-message show">
                      Las contraseñas no coinciden
                    </div>
                  }
                </div>

                <!-- Zona de Peligro -->
                <div class="form-group full-width">
                  <div class="danger-zone">
                    <h3>
                      <i class="fa-solid fa-triangle-exclamation"></i> Zona de Peligro
                    </h3>
                    <p>
                      Una vez que elimines tu cuenta, no hay vuelta atrás. Por favor asegúrate.
                    </p>
                    <button
                      type="button"
                      class="btn btn-danger"
                      (click)="confirmarEliminarCuenta()">
                      <i class="fa-solid fa-trash"></i> Eliminar mi cuenta
                    </button>
                  </div>
                </div>

              </div>

              <!-- Botón Actualizar -->
              <div class="form-navigation" style="justify-content: flex-end; border-top: 2px solid var(--light-green); padding-top: 2rem; margin-top: 2rem;">
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="cargando || seguridadForm.invalid">

                  @if (cargando) {
                    <span class="loading-spinner"></span>
                    Actualizando...
                  } @else {
                    <i class="fa-solid fa-floppy-disk"></i>
                    Actualizar Seguridad
                  }
                </button>
              </div>
            </form>
          </div>
        }

      }
    </section>
  </div>
</main>
